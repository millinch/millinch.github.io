(function(c){var a=a||(function(){var d={};return{add:function(g,h){if(typeof g=="object"){var f;for(f=0;f<g.length;f++){var e=g[f];if(!d[e]){d[e]=[]}d[e].push(h)}}else{if(!d[g]){d[g]=[]}d[g].push(h)}},get:function(e){if(d[e]){return d[e]}}}})(),b=b||function(k){if(typeof String.prototype.repeat!=="function"){String.prototype.repeat=function(p){if(p<1){return""}if(p%2){return this.repeat(p-1)+this}var o=this.repeat(p/2);return o+o}}if(typeof Array.prototype.filter!=="function"){Array.prototype.filter=function(u){if(this===null){throw new TypeError()}var s=Object(this),o=s.length>>>0;if(typeof u!="function"){throw new TypeError()}var r=[],q=arguments[1];for(var p=0;p<o;p++){if(p in s){var v=s[p];if(u.call(q,v,p,s)){r.push(v)}}}return r}}var f={textarea:null,replaceTab:true,softTabs:true,tabSize:4,autoOpen:true,overwrite:true,autoStrip:true,autoIndent:true,fence:false},d,i,j={keyMap:[{open:'"',close:'"',canBreak:false},{open:"'",close:"'",canBreak:false},{open:"(",close:")",canBreak:false},{open:"[",close:"]",canBreak:true},{open:"{",close:"}",canBreak:true}]},l={_callHook:function(s,u){var o=a.get(s);u=typeof u=="boolean"&&u===false?false:true;if(o){if(u){var t=f.textarea,p=t.value,q=l.cursor.get(),r;for(r=0;r<o.length;r++){o[r].call(c,{editor:{element:t,text:p,levelsDeep:l.levelsDeep()},caret:{pos:q},lines:{current:l.cursor.getLine(p,q),total:l.editor.getLines(p)}})}}else{for(r=0;r<o.length;r++){o[r].call(c)}}}},defineNewLine:function(){var o=document.createElement("textarea");o.value="\n";if(o.value.length==2){i="\r\n"}else{i="\n"}},defineTabSize:function(o){if(typeof f.textarea.style.OTabSize!="undefined"){f.textarea.style.OTabSize=o;return}if(typeof f.textarea.style.MozTabSize!="undefined"){f.textarea.style.MozTabSize=o;return}if(typeof f.textarea.style.tabSize!="undefined"){f.textarea.style.tabSize=o;return}},cursor:{getLine:function(o,p){return((o.substring(0,p)).split("\n")).length},get:function(){if(typeof document.createElement("textarea").selectionStart==="number"){return f.textarea.selectionStart}else{if(document.selection){var p=0,o=f.textarea.createTextRange(),q=document.selection.createRange().duplicate(),r=q.getBookmark();o.moveToBookmark(r);while(o.moveStart("character",-1)!==0){p++}return p}}},set:function(q,o){if(!o){o=q}if(f.textarea.setSelectionRange){f.textarea.focus();f.textarea.setSelectionRange(q,o)}else{if(f.textarea.createTextRange){var p=f.textarea.createTextRange();p.collapse(true);p.moveEnd("character",o);p.moveStart("character",q);p.select()}}},selection:function(){var s=f.textarea,v=0,q=0,u,r,p,o,t;if(typeof s.selectionStart=="number"&&typeof s.selectionEnd=="number"){v=s.selectionStart;q=s.selectionEnd}else{r=document.selection.createRange();if(r&&r.parentElement()==s){u=l.editor.get();o=u.length;p=s.createTextRange();p.moveToBookmark(r.getBookmark());t=s.createTextRange();t.collapse(false);if(p.compareEndPoints("StartToEnd",t)>-1){v=q=o}else{v=-p.moveStart("character",-o);v+=u.slice(0,v).split(i).length-1;if(p.compareEndPoints("EndToEnd",t)>-1){q=o}else{q=-p.moveEnd("character",-o);q+=u.slice(0,q).split(i).length-1}}}}return v==q?false:{start:v,end:q}}},editor:{getLines:function(o){return(o).split("\n").length},get:function(){return f.textarea.value.replace(/\r/g,"")},set:function(o){f.textarea.value=o}},fenceRange:function(){if(typeof f.fence=="string"){var p=l.editor.get(),s=l.cursor.get(),r=0,o=p.indexOf(f.fence),q=0;while(o>=0){q++;if(s<(o+r)){break}r+=o+f.fence.length;p=p.substring(o+f.fence.length);o=p.indexOf(f.fence)}if((r)<s&&((o+r)>s)&&q%2===0){return true}return false}else{return true}},isEven:function(p,o){return o%2},levelsDeep:function(){var u=l.cursor.get(),p=l.editor.get();var q=p.substring(0,u),w=0,s,r;for(s=0;s<q.length;s++){for(r=0;r<j.keyMap.length;r++){if(j.keyMap[r].canBreak){if(j.keyMap[r].open==q.charAt(s)){w++}if(j.keyMap[r].close==q.charAt(s)){w--}}}}var t=0,v=["'",'"'];for(s=0;s<j.keyMap.length;s++){if(j.keyMap[s].canBreak){for(r in v){t+=q.split(v[r]).filter(l.isEven).join("").split(j.keyMap[s].open).length-1}}}var o=w-t;return o>=0?o:0},deepExtend:function(o,q){for(var p in q){if(q[p]&&q[p].constructor&&q[p].constructor===Object){o[p]=o[p]||{};l.deepExtend(o[p],q[p])}else{o[p]=q[p]}}return o},addEvent:function g(p,o,q){if(p.addEventListener){p.addEventListener(o,q,false)}else{if(p.attachEvent){p.attachEvent("on"+o,q)}}},removeEvent:function g(p,o,q){if(p.addEventListener){p.removeEventListener(o,q,false)}else{if(p.attachEvent){p.detachEvent("on"+o,q)}}},preventDefaultEvent:function(o){if(o.preventDefault){o.preventDefault()}else{o.returnValue=false}}},m={tabKey:function(t){if(!l.fenceRange()){return}if(t.keyCode==9){l.preventDefaultEvent(t);var s=true;l._callHook("tab:before");var w=l.cursor.selection(),v=l.cursor.get(),o=l.editor.get();if(w){var q=w.start;while(q--){if(o.charAt(q)=="\n"){w.start=q+1;break}}var y=o.substring(w.start,w.end),z=y.split("\n"),r;if(t.shiftKey){for(r=0;r<z.length;r++){if(z[r].substring(0,d.length)==d){z[r]=z[r].substring(d.length)
}}y=z.join("\n");l.editor.set(o.substring(0,w.start)+y+o.substring(w.end));l.cursor.set(w.start,w.start+y.length)}else{for(r in z){z[r]=d+z[r]}y=z.join("\n");l.editor.set(o.substring(0,w.start)+y+o.substring(w.end));l.cursor.set(w.start,w.start+y.length)}}else{var p=o.substring(0,v),x=o.substring(v),u=p+d+x;if(t.shiftKey){if(o.substring(v-d.length,v)==d){u=o.substring(0,v-d.length)+x;l.editor.set(u);l.cursor.set(v-d.length)}}else{l.editor.set(u);l.cursor.set(v+d.length);s=false}}l._callHook("tab:after")}return s},enterKey:function(u){if(!l.fenceRange()){return}if(u.keyCode==13){l.preventDefaultEvent(u);l._callHook("enter:before");var x=l.cursor.get(),q=l.editor.get(),r=q.substring(0,x),y=q.substring(x),A=r.charAt(r.length-1),w=y.charAt(0),s=l.levelsDeep(),p="",o="",z,t;if(!s){z=1}else{while(s--){p+=d}p=p;z=p.length+1;for(t=0;t<j.keyMap.length;t++){if(j.keyMap[t].open==A&&j.keyMap[t].close==w){o=i}}}var v=r+i+p+o+(p.substring(0,p.length-d.length))+y;l.editor.set(v);l.cursor.set(x+z);l._callHook("enter:after")}},deleteKey:function(s){if(!l.fenceRange()){return}if(s.keyCode==8){l.preventDefaultEvent(s);l._callHook("delete:before");var v=l.cursor.get(),p=l.editor.get(),q=p.substring(0,v),w=p.substring(v),x=q.charAt(q.length-1),u=w.charAt(0),r;if(l.cursor.selection()===false){for(r=0;r<j.keyMap.length;r++){if(j.keyMap[r].open==x&&j.keyMap[r].close==u){var t=p.substring(0,v-1)+p.substring(v+1);l.editor.set(t);l.cursor.set(v-1);return}}var t=p.substring(0,v-1)+p.substring(v);l.editor.set(t);l.cursor.set(v-1)}else{var o=l.cursor.selection(),t=p.substring(0,o.start)+p.substring(o.end);l.editor.set(t);l.cursor.set(v)}l._callHook("delete:after")}}},h={openedChar:function(o,r){l.preventDefaultEvent(r);l._callHook("openChar:before");var u=l.cursor.get(),s=l.editor.get(),q=s.substring(0,u),p=s.substring(u),t=q+o.open+o.close+p;f.textarea.value=t;l.cursor.set(u+1);l._callHook("openChar:after")},closedChar:function(o,q){var s=l.cursor.get(),r=l.editor.get(),p=r.substring(s,s+1);if(p==o.close){l.preventDefaultEvent(q);l._callHook("closeChar:before");l.cursor.set(l.cursor.get()+1);l._callHook("closeChar:after");return true}return false}},e={filter:function(q){if(!l.fenceRange()){return}var s=q.which||q.keyCode;if(s==39||s==40&&q.which===0){return}var o=String.fromCharCode(s),p;for(p=0;p<j.keyMap.length;p++){if(j.keyMap[p].close==o){var r=f.overwrite&&h.closedChar(j.keyMap[p],q);if(!r&&j.keyMap[p].open==o&&f.autoOpen){h.openedChar(j.keyMap[p],q)}}else{if(j.keyMap[p].open==o&&f.autoOpen){h.openedChar(j.keyMap[p],q)}}}},listen:function(){if(f.replaceTab){l.addEvent(f.textarea,"keydown",m.tabKey)}if(f.autoIndent){l.addEvent(f.textarea,"keydown",m.enterKey)}if(f.autoStrip){l.addEvent(f.textarea,"keydown",m.deleteKey)}l.addEvent(f.textarea,"keypress",e.filter);l.addEvent(f.textarea,"keydown",function(){l._callHook("keydown")});l.addEvent(f.textarea,"keyup",function(){l._callHook("keyup")})}},n=function(o){if(o.textarea){l._callHook("init:before",false);l.deepExtend(f,o);l.defineNewLine();if(f.softTabs){d=" ".repeat(f.tabSize)}else{d="\t";l.defineTabSize(f.tabSize)}e.listen();l._callHook("init:after",false)}};this.destroy=function(){l.removeEvent(f.textarea,"keydown",m.tabKey);l.removeEvent(f.textarea,"keydown",m.enterKey);l.removeEvent(f.textarea,"keydown",m.deleteKey);l.removeEvent(f.textarea,"keypress",e.filter)};n(k)};if(typeof module!=="undefined"&&module.exports){module.exports=b}if(typeof ender==="undefined"){this.Behave=b;this.BehaveHooks=a}if(typeof define==="function"&&define.amd){define("behave",[],function(){return b})}}).call(this);